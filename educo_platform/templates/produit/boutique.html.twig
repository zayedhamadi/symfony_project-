{% extends 'side-bar-parentvf.html.twig' %}

{% block title %}Boutique{% endblock %}

{% block body %}
    <div class="container" style="margin-top: 100px !important; padding: 0 15px !important;">

        <h1 class="text-center my-4 mb-4">Notre Boutique</h1>
        <div class="d-flex justify-content-between align-items-start mb-3" style="padding: 0 58px !important;">
        <!-- IcÃ´ne du panier -->

        <!-- Formulaire de recherche et filtre par catÃ©gorie -->
        <div class="d-flex justify-content-between mb-3">
            <form action="{{ path('app_boutique') }}" method="get" class="d-flex w-100">
                <!-- Champ de recherche -->
                <input type="text" name="search" class="form-control me-2" placeholder="Rechercher un produit" value="{{ search }}" style="max-width: 250px;">

                <!-- SÃ©lecteur de catÃ©gorie -->
                <select name="category" class="form-select me-2" style="max-width: 200px;">
                    <option value="">Toutes les catÃ©gories</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id == selectedCategory %}selected{% endif %}>{{ category.nom }}</option>
                    {% endfor %}
                </select>
                <!-- Bouton unique pour Recherche et Filtrage -->
                <button type="submit" class="btn btn-primary ms-2" style="font-size: 1rem;">
                    <i class="bi bi-search"></i>  Filtrer
                </button>
            </form>
        </div>
            <div class="d-flex justify-content-end mb-3">
                <a href="{{ path('app_panier_view') }}" class="btn btn-light position-relative">
                    ðŸ›’ Panier
                    <span id="panier-total" class="badge bg-danger position-absolute top-0 start-100 translate-middle">
                    {{ app.session.get('panier')|default([])|reduce((total, q) => total + q, 0) }}
                </span>
                </a>
            </div>
        </div>



        <div class="container">
            <div class="row">
                {% for produit in produits %}
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <!-- Lien cliquable pour rediriger vers les dÃ©tails du produit -->
                            <a href="{{ path('app_produit_details_parent', {'id': produit.id}) }}" class="text-decoration-none">
                                <!-- Image du produit -->
                                <img src="{{ asset('uploads/' ~ produit.image) }}" class="card-img-top" alt="{{ produit.nom }}" style="height: 250px;">

                                <div class="card-body text-center">
                                    <h5 class="card-title">{{ produit.nom }}</h5>
                                    <p class="card-text">{{ produit.description|slice(0, 100) ~ '...' }}</p>
                                    <p class="text-primary"><strong>{{ produit.prix }} dt</strong></p>
                                </div>
                            </a>

                            <!-- Bouton Ajouter au panier sur la mÃªme ligne -->
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{{ path('app_produit_details_parent', {'id': produit.id}) }}" class="btn btn-primary mb-4">Voir DÃ©tails</a>

                                <!-- Formulaire d'ajout au panier -->
                                <form action="{{ path('app_panier_add', {'id': produit.id}) }}" method="post" class="add-to-cart">
                                    <button type="submit" class="btn btn-success mb-2">ðŸ›’ Ajouter au Panier</button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-center">Aucun produit disponible pour le moment.</p>
                {% endfor %}

                <div class="d-flex justify-content-center">
                    {{ knp_pagination_render(produits) }}
                </div>
        </div>
        <!-- Ajout de la pagination -->

    </div>

    <!-- Script pour empÃªcher le rechargement et mettre Ã  jour le panier -->
    <script>
        document.querySelectorAll('.add-to-cart').forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // EmpÃªcher le rechargement de la page

                let formData = new FormData(this);
                let actionUrl = this.action;

                fetch(actionUrl, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' } // Indiquer une requÃªte AJAX
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message); // Afficher un message (remplaÃ§able par une notification)
                            document.getElementById('panier-total').textContent = data.panier_total; // Mettre Ã  jour le panier
                        }
                    })
                    .catch(error => console.error('Erreur:', error));
            });
        });
    </script>

    <style>
        .form-control, .form-select {
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
    </style>
{% endblock %}

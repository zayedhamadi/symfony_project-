{% extends 'side-bar.html.twig' %}

{% block title %}Boutique{% endblock %}

{% block body %}
    <div class="container" style="margin-top: 100px !important; padding: 0 15px !important;">

        <h1 class="text-center my-4" class="mb-4">Notre Boutique</h1>

        <!-- IcÃ´ne du panier -->
        <div class="d-flex justify-content-end mb-3">
            <a href="{{ path('app_panier_view') }}" class="btn btn-light position-relative">
                ðŸ›’ Panier
                <span id="panier-total" class="badge bg-danger position-absolute top-0 start-100 translate-middle">
                    {{ app.session.get('panier')|default([])|reduce((total, q) => total + q, 0) }}
                </span>
            </a>
        </div>

        <div class="container">
            <div class="row">
                {% for produit in produits %}
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <!-- Lien cliquable pour rediriger vers les dÃ©tails du produit -->
                            <a href="{{ path('app_produit_details_parent', {'id': produit.id}) }}" class="text-decoration-none">
                                <!-- Image du produit -->
                                <img src="{{ asset('uploads/' ~ produit.image) }}" class="card-img-top" alt="{{ produit.nom }}" style="height: 250px; object-fit: cover;">

                                <div class="card-body text-center">
                                    <h5 class="card-title">{{ produit.nom }}</h5>
                                    <p class="card-text">{{ produit.description|slice(0, 100) ~ '...' }}</p>
                                    <p class="text-primary"><strong>{{ produit.prix }} dt</strong></p>
                                </div>
                            </a>

                            <!-- Bouton Ajouter au panier sur la mÃªme ligne -->
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{{ path('app_produit_details_parent', {'id': produit.id}) }}" class="btn btn-primary">Voir DÃ©tails</a>

                                <!-- Formulaire d'ajout au panier -->
                                <form action="{{ path('app_panier_add', {'id': produit.id}) }}" method="post" class="add-to-cart">
                                    <button type="submit" class="btn btn-success">ðŸ›’ Ajouter au Panier</button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-center">Aucun produit disponible pour le moment.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Script pour empÃªcher le rechargement et mettre Ã  jour le panier -->
    <script>
        document.querySelectorAll('.add-to-cart').forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // EmpÃªcher le rechargement de la page

                let formData = new FormData(this);
                let actionUrl = this.action;

                fetch(actionUrl, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' } // Indiquer une requÃªte AJAX
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message); // Afficher un message (remplaÃ§able par une notification)
                            document.getElementById('panier-total').textContent = data.panier_total; // Mettre Ã  jour le panier
                        }
                    })
                    .catch(error => console.error('Erreur:', error));
            });
        });
    </script>

{% endblock %}
